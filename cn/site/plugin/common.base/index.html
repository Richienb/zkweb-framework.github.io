<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>基础插件 (Common.Base) - ZKWeb框架文档</title>
  <link href="../../img/favicon.ico" rel="icon" type="image/x-icon">
  <link rel="canonical" href="None" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="基础插件 (Common.Base), 基础插件 (Common.Base)">
  <meta name="author" content="Tom Christie">

  <!-- Le styles -->
  <link href="../../css/prettify.css" rel="stylesheet">
  <link href="../../css/bootstrap.css" rel="stylesheet">
  <link href="../../css/bootstrap-responsive.css" rel="stylesheet">
  <link href="../../css/default.css" rel="stylesheet">
</head>
<body onload="prettyPrint()" class="-page">

  <div class="wrapper">
        <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="repo-link btn btn-primary btn-small" href="https://github.com/zkweb-framework" target="_blank">GitHub</a>
          <a class="repo-link btn btn-inverse btn-small " rel="prev" href="../common.captcha/">
            下一页 <i class="icon-arrow-right icon-white"></i>
          </a>
          <a class="repo-link btn btn-inverse btn-small " rel="next" href="../../core/unittest/">
            <i class="icon-arrow-left icon-white"></i> 上一页
          </a>
          <a id="search_modal_show" class="repo-link btn btn-inverse btn-small" href="#mkdocs_search_modal" data-toggle="modal" data-target="#mkdocs_search_modal"><i class="icon-search icon-white"></i> 搜索</a>
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="../..">ZKWeb框架文档</a>
          <div class="nav-collapse collapse">
            
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
               
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">框架入门 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  
                  <li >
                    <a href="../..">框架介绍</a>
                  </li>
                  
                </ul>
              </li>
                
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">核心功能 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  
                  <li >
                    <a href="../../core/gettingstart/">首次运行</a>
                  </li>
                  
                  <li >
                    <a href="../../core/config/">网站配置</a>
                  </li>
                  
                  <li >
                    <a href="../../core/plugin/">插件系统</a>
                  </li>
                  
                  <li >
                    <a href="../../core/controller/">控制器和模板系统</a>
                  </li>
                  
                  <li >
                    <a href="../../core/localize/">本地化</a>
                  </li>
                  
                  <li >
                    <a href="../../core/database/">数据库管理</a>
                  </li>
                  
                  <li >
                    <a href="../../core/unittest/">单元测试</a>
                  </li>
                  
                </ul>
              </li>
                
              <li class="dropdown active">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">插件 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  
                  <li class="active" >
                    <a href="./">基础插件 (Common.Base)</a>
                  </li>
                  
                  <li >
                    <a href="../common.captcha/">验证码 (Common.Captcha)</a>
                  </li>
                  
                  <li >
                    <a href="../common.admin/">管理员 (Common.Admin)</a>
                  </li>
                  
                  <li >
                    <a href="../common.menupage/">菜单页 (Common.MenuPage)</a>
                  </li>
                  
                  <li >
                    <a href="../common.adminsettings/">管理员设置 (Common.AdminSettings)</a>
                  </li>
                  
                  <li >
                    <a href="../common.userpanel/">用户中心 (Common.UserPanel)</a>
                  </li>
                  
                  <li >
                    <a href="../common.usercontact/">联系人 (Common.UserContact)</a>
                  </li>
                  
                  <li >
                    <a href="../common.genericclass/">通用分类 (Common.GenericClass)</a>
                  </li>
                  
                  <li >
                    <a href="../common.generictag/">通用标签 (Common.GenericTag)</a>
                  </li>
                  
                  <li >
                    <a href="../common.genericrecord/">通用记录 (Common.GenericRecord)</a>
                  </li>
                  
                  <li >
                    <a href="../common.languageswitcher/">语言切换器 (Common.LanguageSwitcher)</a>
                  </li>
                  
                  <li >
                    <a href="../common.currency/">货币 (Common.Currency)</a>
                  </li>
                  
                  <li >
                    <a href="../common.pesudostatic/">伪静态 (Common.PesudoStatic)</a>
                  </li>
                  
                  <li >
                    <a href="../common.region/">地区 (Common.Region)</a>
                  </li>
                  
                  <li >
                    <a href="../common.serialgenerate/">流水号 (Common.SerialGenerate)</a>
                  </li>
                  
                  <li >
                    <a href="../common.payment/">支付 (Finance.Payment)</a>
                  </li>
                  
                  <li >
                    <a href="../common.payment.alipay/">支付宝 (Finance.Payment.Alipay)</a>
                  </li>
                  
                  <li >
                    <a href="../common.payment.tenpay/">财付通 (Finance.Payment.Tenpay)</a>
                  </li>
                  
                  <li >
                    <a href="../common.payment.wechat/">微信支付 (Finance.Payment.WeChat)</a>
                  </li>
                  
                  <li >
                    <a href="../cms.ckeditor/">CKEditor (CMS.CKEditor)</a>
                  </li>
                  
                  <li >
                    <a href="../cms.imagebrowser/">图片管理器 (CMS.ImageBrowser)</a>
                  </li>
                  
                  <li >
                    <a href="../cms.atricle/">文章 (CMS.Article)</a>
                  </li>
                  
                  <li >
                    <a href="../shopping.product/">商品 (Shopping.Product)</a>
                  </li>
                  
                  <li >
                    <a href="../shopping.logistics/">物流 (Shopping.Logistics)</a>
                  </li>
                  
                  <li >
                    <a href="../shopping.order/">订单 (Shopping.Order)</a>
                  </li>
                  
                  <li >
                    <a href="../shopping.aftersales/">售后 (Shopping.AfterSales)</a>
                  </li>
                  
                  <li >
                    <a href="../unittest.webtester/">网页测试运行器 (UnitTest.WebTester)</a>
                  </li>
                  
                  <li >
                    <a href="../common.customtranslate/">自定义翻译 (Common.CustomTranslate)</a>
                  </li>
                  
                </ul>
              </li>
               

            </ul>
            
          </div>
          <!--/.nav-collapse -->

        </div>
      </div>
    </div>

    <div class="body-content">
      <div class="container-fluid">
        <!-- Search Modal -->
        <div id="mkdocs_search_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3 id="myModalLabel">搜索文档</h3>
          </div>

          <div class="modal-body">
            <form role="form" autocomplete="off">
              <div class="form-group">
                <input type="text" name="q" class="form-control" placeholder="关键词" id="mkdocs-search-query">
              </div>
            </form>
            <div id="mkdocs-search-results"></div>
          </div>

          <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
          </div>
        </div>

        <div class="row-fluid">
          <div class="span3 hide">
            <div id="table-of-contents">
              <ul class="nav nav-list side-nav well sidebar-nav-fixed">
                

                
                  <li class="main">
                    <a href="#_1">通用配置</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_2">定时任务</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_3">会话</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#css">css样式</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#js">js脚本</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_4">图标字体</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#ajax">Ajax表格构建器</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_5">静态表格构建器</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_6">表单构建器</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_7">插件提供的表单字段类型</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_8">数据库操作类</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_9">前台页模板</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_10">插件提供的标签和过滤器</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_11">静态文件处理器</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_12">语言时区处理器</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_13">特征类</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_14">缓存的隔离策略</a>
                  </li>

                  
                
                  <li class="main">
                    <a href="#_15">全局过滤网址</a>
                  </li>

                  
                

                  <div class="promo">
                    <hr/>
                    <div id="sidebarInclude">
                  </div>
              </ul>

            </div>
          </div>

          <div id="main-content" class="span9">
            
              
                <h1>基础插件 (Common.Base)</h1><br/>
              
              <p>插件包含了通用性高的最基本的功能和资源，可以满足大部分网站的需求。<br/>
在示例项目中使用这个插件时请先引用<code>Common.Base\bin\Common.Base.dll</code>，否则VS会提示错误（但不影响ZKWeb加载）。<br/></p>
<hr />
<h3 id="_1"><h2>通用配置</h2></h3>
<p>通用配置可以保存网站全局使用的参数，例如网站名称和默认语言等。<br/>
添加<code>Example\src\config\ExampleConfig.cs</code>，内容如下<br/></p>
<pre><code class="csharp">/// &lt;summary&gt;
/// 示例配置
/// &lt;/summary&gt;
[GenericConfig(&quot;Example.ExampleConfig&quot;, CacheTime = 15)]
public class ExampleConfig {
    public string ExampleName { get; set; }
    public int ExampleCount { get; set; }
}
</code></pre>

<p>配置需要添加<code>GenericConfig</code>属性，第一个参数是保存到数据库时使用的键名，CacheTime可以指定缓存时间（秒）。<br/>
缓存时间不会影响到网站部署到单个进程时的读取，单个进程时读取配置总能读到最新的配置。<br/>
但会影响网站部署到多个进程或服务器时的读取，缓存时间不应该指定太长。<br/></p>
<p>读取和写入配置<br/>
注意首次获取<code>ExampleConfig</code>或之前保存了null值时会返回一个新的实例，GetData不会返回null。<br/>
在<code>ExampleController</code>下添加以下内容<br/></p>
<pre><code class="csharp">[Action(&quot;example/read_config&quot;)]
public string ReadConfig() {
    var configManager = Application.Ioc.Resolve&lt;GenericConfigManager&gt;();
    var config = configManager.GetData&lt;ExampleConfig&gt;();
    return JsonConvert.SerializeObject(config);
}

[Action(&quot;example/write_config&quot;)]
public string WriteConfig() {
    var configManager = Application.Ioc.Resolve&lt;GenericConfigManager&gt;();
    var config = configManager.GetData&lt;ExampleConfig&gt;();
    config.ExampleName = &quot;updated&quot;;
    config.ExampleCount++;
    configManager.PutData(config);
    return &quot;success&quot;;
}
</code></pre>

<h3 id="_2"><h2>定时任务</h2></h3>
<p>定时任务可以用于在网站后台执行定时处理。<br/>
注意网站被IIS回收后，将不会定时执行这些任务（其他的网站内嵌定时任务框架也一样），<br/>
如果需要定时任务必须在指定的时间运行，请设置IIS程序池常驻或使用独立的进程处理。<br/>
定时任务已考虑到部署到多个服务器时的情况，部署到多个服务器仍可以保证任务不被重复执行。<br/></p>
<p>添加<code>Example\src\ScheduledTasks\ExampleTask.cs</code>，内容如下<br/>
这个任务每15分钟写入一次日志<br/></p>
<pre><code class="csharp">/// &lt;summary&gt;
/// 示例任务
/// &lt;/summary&gt;
[ExportMany, SingletonReuse]
public class ExampleTask : IScheduledTaskExecutor {
    public string Key { get { return &quot;Example.ExampleTask&quot;; } }

    public bool ShouldExecuteNow(DateTime lastExecuted) {
        return ((DateTime.UtcNow - lastExecuted).TotalMinutes &gt; 15);
    }

    public void Execute() {
        var logManager = Application.Ioc.Resolve&lt;LogManager&gt;();
        logManager.LogDebug(&quot;Example task executed&quot;);
    }
}
</code></pre>

<h3 id="_3"><h2>会话</h2></h3>
<p>考虑到网站部署到多个服务器，会话应该保存到数据库中。<br/>
会话会在当前请求期间共享同一个对象，但不会缓存到这个期间外。<br/></p>
<p>获取和保存会话<br/>
在<code>ExampleController</code>下添加以下内容<br/>
调用<code>SaveSession</code>可以保存之前使用<code>GetSession</code>获取的会话。<br/></p>
<pre><code class="csharp">[Action(&quot;example/get_session&quot;)]
public string GetSession() {
    var sessionManager = Application.Ioc.Resolve&lt;SessionManager&gt;();
    var session = sessionManager.GetSession();
    return JsonConvert.SerializeObject(session, Formatting.Indented);
}

[Action(&quot;example/save_session&quot;)]
public string SaveSession() {
    var sessionManager = Application.Ioc.Resolve&lt;SessionManager&gt;();
    var session = sessionManager.GetSession();
    session.Items[&quot;ExampleKey&quot;] = DateTime.UtcNow;
    sessionManager.SaveSession();
    return &quot;success&quot;;
}
</code></pre>

<p>会话有过期时间，需要延长过期时间时可以使用<code>SetExpiresAtLeast</code>函数。<br/>
以下代码设置会话最少有效一个小时<br/></p>
<pre><code class="csharp">session.SetExpiresAtLeast(TimeSpan.FromHours(1));
</code></pre>

<h3 id="css"><h2>css样式</h2></h3>
<p>这个插件使用了以下css样式，具体用法可以参考他们的官网<br/></p>
<ul>
<li>Bootstrap 3.3.2</li>
<li>AdminLTE 2.3.0</li>
</ul>
<h3 id="js"><h2>js脚本</h2></h3>
<p>这个插件使用了以下js脚本，具体用法可以参考他们的官网<br/></p>
<ul>
<li>jQuery 1.11.2<ul>
<li>jquery-migrate</li>
<li>jquery-form</li>
<li>jquery-mobile</li>
<li>jquery-toast</li>
<li>jquery-validate</li>
<li>jquery-validate-unobtrusive</li>
</ul>
</li>
<li>Bootstrap 3.3.2<ul>
<li>context-menu</li>
<li>dialog</li>
<li>hover-dropdown</li>
</ul>
</li>
<li>Switchery 0.8.1</li>
<li>jsUri 1.3.1</li>
<li>Underscore 1.8.3</li>
</ul>
<p>这个插件还带了很多零碎的附加功能，具体可以参考<code>Common.Base\static\common.base.js\custom</code>。</p>
<h3 id="_4"><h2>图标字体</h2></h3>
<p>这个插件使用了以下图标字体，具体用法可以参考他们的官网<br/></p>
<ul>
<li>Font Awesome 4.5.0</li>
</ul>
<h3 id="ajax"><h2>Ajax表格构建器</h2></h3>
<p>Ajax表格构建器可以用于构建从远程载入内容的Ajax表格，并带分页等支持。<br/>
以下例子没有针对前台显示优化，实际在前台使用时需要其他样式。<br/>
表格构建器可以单独使用，不一定和搜索栏构建器一起使用。<br/></p>
<p>在<code>ExampleController</code>下添加以下内容</p>
<pre><code class="csharp">[Action(&quot;example/table&quot;)]
public IActionResult Table() {
    var table = new AjaxTableBuilder();
    table.Id = &quot;ExampleTable&quot;;
    table.Target = &quot;/example/table/search&quot;;
    var searchBar = new AjaxTableSearchBarBuilder();
    searchBar.TableId = table.Id;
    searchBar.Conditions.Add(new FormField(new CheckBoxFieldAttribute(&quot;Deleted&quot;)));
    return new TemplateResult(&quot;example/example_table.html&quot;, new { table, searchBar });
}

[Action(&quot;example/table/search&quot;, HttpMethods.POST)]
public IActionResult TableSearch() {
    var json = HttpManager.CurrentContext.Request.Get&lt;string&gt;(&quot;json&quot;);
    var request = AjaxTableSearchRequest.FromJson(json);
    var response = request.BuildResponseFromDatabase(new[] { new ExampleAjaxTableCallback() });
    return new JsonResult(response);
}
</code></pre>

<p>添加<code>Example\templates\example\example_table.html</code>，内容如下</p>
<pre><code class="html">{% use_title &quot;Example Table&quot; %}
{% include common.base/header.html %}

&lt;div class=&quot;portlet&quot;&gt;
    {{ searchBar }}
    {{ table }}
&lt;/div&gt;

{% include common.base/footer.html %}
</code></pre>

<p>添加<code>Example\src\AjaxTableCallbacks\ExampleAjaxTableCallback.cs</code>，内容如下</p>
<pre><code class="csharp">/// &lt;summary&gt;
/// 示例的表格搜索回调
/// &lt;/summary&gt;
public class ExampleAjaxTableCallback : IAjaxTableCallback&lt;ExampleTable&gt; {
    /// &lt;summary&gt;
    /// 构建表格时的处理，这里不使用
    /// &lt;/summary&gt;
    public void OnBuildTable(AjaxTableBuilder table, AjaxTableSearchBarBuilder searchBar) { }

    /// &lt;summary&gt;
    /// 查询数据
    /// &lt;/summary&gt;
    public void OnQuery(
        AjaxTableSearchRequest request, DatabaseContext context, ref IQueryable&lt;ExampleTable&gt; query) {
        if (!string.IsNullOrEmpty(request.Keyword)) {
            query = query.Where(q =&gt; q.Name.Contains(request.Keyword));
        }
        bool deleted = request.Conditions.GetOrDefault&lt;string&gt;(&quot;Deleted&quot;) == &quot;on&quot;;
        query = query.Where(q =&gt; q.Deleted == deleted);
    }

    /// &lt;summary&gt;
    /// 排序数据
    /// &lt;/summary&gt;
    public void OnSort(
        AjaxTableSearchRequest request, DatabaseContext context, ref IQueryable&lt;ExampleTable&gt; query) {
        query = query.OrderByDescending(q =&gt; q.Id);
    }

    /// &lt;summary&gt;
    /// 选择数据
    /// &lt;/summary&gt;
    public void OnSelect(
        AjaxTableSearchRequest request, List&lt;EntityToTableRow&lt;ExampleTable&gt;&gt; pairs) {
        foreach (var pair in pairs) {
            pair.Row[&quot;Id&quot;] = pair.Entity.Id;
            pair.Row[&quot;Name&quot;] = pair.Entity.Name;
            pair.Row[&quot;CreateTime&quot;] = pair.Entity.CreateTime.ToClientTimeString();
        }
    }

    /// &lt;summary&gt;
    /// 添加列和操作等
    /// &lt;/summary&gt;
    public void OnResponse(AjaxTableSearchRequest request, AjaxTableSearchResponse response) {
        response.Columns.AddIdColumn(&quot;Id&quot;);
        response.Columns.AddMemberColumn(&quot;Name&quot;);
        response.Columns.AddMemberColumn(&quot;CreateTime&quot;);
    }
}
</code></pre>

<p>效果<br/>
<img alt="" src="../../img/ajaxtable.jpg" />
在这个例子中表格使用了<code>AjaxTableSearchResponse.FromRequest</code>来构建搜索结果，<br/>
这个函数可以自动从数据库中获取数据，交给表格搜索回调处理并进行分页，<br/>
如果需要自己处理也可以自己构建<code>AjaxTableSearchResponse</code>的数据。<br/>
使用表格回调的原因是搜索时可以支持多个回调，这样易于修改其他插件的表格内容。<br/></p>
<p>默认表格的样式在<code>static/common.base.tmpl/ajaxTable.tmpl</code>中，<br/>
如果需要使用自己的样式可以修改<code>table.Template</code>。<br/></p>
<h3 id="_5"><h2>静态表格构建器</h2></h3>
<p>静态表格构建器和Ajax表格器不同的时，构建的内容需要使用模板绑定并静态显示，不支持通过Ajax更新。<br/>
静态表格的参数来源一般来自url。<br/></p>
<p>在<code>ExampleController</code>下添加以下内容</p>
<pre><code class="csharp">[Action(&quot;example/static_table&quot;)]
public IActionResult StaticTable() {
    var request = StaticTableSearchRequest.FromHttpRequest();
    var response = request.BuildResponseFromDatabase(new[] { new ExampleStaticTableCallback() });
    return new TemplateResult(&quot;example/example_static_table.html&quot;, new { response });
}
</code></pre>

<p>添加<code>Example\templates\example\example_static_table.html</code>，内容如下</p>
<pre><code class="html">{% use_title &quot;Example Table&quot; %}
{% include common.base/header.html %}

&lt;div class=&quot;portlet&quot;&gt;
    &lt;div&gt;
        {% for row in response.Rows %}
        &lt;div&gt;
            &lt;a&gt;{{ row.Name }}&lt;/a&gt;
            &lt;span&gt;{{ row.CreateTime }}&lt;/span&gt;
        &lt;/div&gt;
        {% endfor %}
    &lt;/div&gt;
    {% url_pagination response.Pagination %}
&lt;/div&gt;

{% include common.base/footer.html %}
</code></pre>

<p>添加<code>Example\src\StaticTableCallbacks\ExampleStaticTableCallback.cs</code>，内容如下</p>
<pre><code class="csharp">/// &lt;summary&gt;
/// 示例的表格搜索回调
/// &lt;/summary&gt;
public class ExampleStaticTableCallback : IStaticTableCallback&lt;ExampleTable&gt; {
    /// &lt;summary&gt;
    /// 查询数据
    /// &lt;/summary&gt;
    public void OnQuery(
        StaticTableSearchRequest request, DatabaseContext context, ref IQueryable&lt;ExampleTable&gt; query) {
        if (!string.IsNullOrEmpty(request.Keyword)) {
            query = query.Where(q =&gt; q.Name.Contains(request.Keyword));
        }
        query = query.Where(q =&gt; !q.Deleted);
    }

    /// &lt;summary&gt;
    /// 排序数据
    /// &lt;/summary&gt;
    public void OnSort(
        StaticTableSearchRequest request, DatabaseContext context, ref IQueryable&lt;ExampleTable&gt; query) {
        query = query.OrderByDescending(q =&gt; q.Id);
    }

    /// &lt;summary&gt;
    /// 选择数据
    /// &lt;/summary&gt;
    public void OnSelect(
        StaticTableSearchRequest request, List&lt;EntityToTableRow&lt;ExampleTable&gt;&gt; pairs) {
        foreach (var pair in pairs) {
            pair.Row[&quot;Id&quot;] = pair.Entity.Id;
            pair.Row[&quot;Name&quot;] = pair.Entity.Name;
            pair.Row[&quot;CreateTime&quot;] = pair.Entity.CreateTime.ToClientTimeString();
        }
    }
}
</code></pre>

<p>效果<br/>
<img alt="" src="../../img/static_table.jpg" /></p>
<h3 id="_6"><h2>表单构建器</h2></h3>
<p>表单构建器可以构建常用的表单，并支持多种表单字段和客户端+服务端验证。<br/>
默认构建的表单都会带CSRF校验值，防止跨站攻击。<br/>
使用例子<br/></p>
<p>在<code>ExampleController</code>下添加以下内容</p>
<pre><code class="csharp">[Action(&quot;example/form&quot;)]
[Action(&quot;example/form&quot;, HttpMethods.POST)]
public IActionResult Form() {
    var form = new ExampleForm();
    if (HttpManager.CurrentContext.Request.Method == HttpMethods.POST) {
        return new JsonResult(form.Submit());
    } else {
        form.Bind();
        return new TemplateResult(&quot;example/example_form.html&quot;, new { form });
    }
}
</code></pre>

<p>添加<code>Example\templates\example\example_form.html</code>，内容如下</p>
<pre><code class="html">{% use_title &quot;Example Form&quot; %}
{% include common.base/header.html %}

&lt;div class=&quot;portlet&quot;&gt;
    {{ form }}
&lt;/div&gt;

{% include common.base/footer.html %}
</code></pre>

<p>添加<code>Example\src\Forms\ExampleForm.cs</code>，内容如下<br/>
提示<code>[Required]</code>属性找不到时请引用程序集<code>System.ComponentModel.DataAnnotations</code><br/></p>
<pre><code class="csharp">/// &lt;summary&gt;
/// 示例表单
/// &lt;/summary&gt;
public class ExampleForm : ModelFormBuilder {
    [Required]
    [StringLength(100)]
    [TextBoxField(&quot;Name&quot;, &quot;Please enter name&quot;)]
    public string Name { get; set; }
    [Required]
    [TextBoxField(&quot;Age&quot;, &quot;Please enter age&quot;)]
    public int Age { get; set; }

    protected override void OnBind() {
        Name = &quot;Tom&quot;;
        Age = 25;
    }

    protected override object OnSubmit() {
        var message = string.Format(&quot;Hello, {0} ({1})&quot;, Name, Age);
        return new { message };
    }
}
</code></pre>

<p>效果<br/>
<img alt="" src="../../img/ajaxform.jpg" /></p>
<h3 id="_7"><h2>插件提供的表单字段类型</h2></h3>
<p>这个插件提供了以下表单字段类型，使用时请参考各个字段的文档。<br/></p>
<ul>
<li>LabelFieldAttribute(string name)</li>
<li>TextBoxFieldAttribute(string name, string placeHolder = null)</li>
<li>PasswordFieldAttribute(string name, string placeHolder = null)</li>
<li>TextAreaFieldAttribute(string name, int rows, string placeHolder = null)</li>
<li>CheckBoxFieldAttribute(string name)</li>
<li>CheckBoxGroupFieldAttribute(string name, Type source)</li>
<li>CheckBoxGroupsFieldAttribute(string name, Type source)</li>
<li>CheckBoxTreeFieldAttribute(string name, Type source)</li>
<li>DropdownListFieldAttribute(string name, Type source)</li>
<li>SearchableDropdownListFieldAttribute(string name, Type source)</li>
<li>RadioButtonsFieldAttribute(string name, Type sources)</li>
<li>FileUploaderFieldAttribute(string name, string extensions = null, int maxContentsLength = 0)</li>
<li>HiddenFieldAttribute(string name)</li>
<li>JsonFieldAttribute(string name, Type fieldType)</li>
<li>HtmlFieldAttribute(string name)</li>
<li>RichTextEditorAttribute(string name, string config)</li>
<li>这个类型需要引用其他插件实现，现成的插件可以引用CMS.CKEditor</li>
</ul>
<h3 id="_8"><h2>数据库操作类</h2></h3>
<p>为了简化数据库操作，这个插件提供了通用仓储<code>GenericRepository</code>和工作单元<code>UnitOfWork</code>。<br/>
<code>GenericRepository</code>提供了共通的操作函数，<code>UnitOfWork</code>负责管理数据库上下文和事务的提交。<br/>
使用例子<br/></p>
<p>在<code>ExampleController</code>下添加以下内容</p>
<pre><code class="csharp">[Action(&quot;example/uow&quot;)]
public string Uow() {
    // insert data
    string name = RandomUtils.RandomString(5);
    UnitOfWork.WriteData&lt;ExampleTable&gt;(r =&gt; {
        var data = new ExampleTable() { Name = name };
        r.Save(ref data);
    });
    // read inserted data
    var readData = UnitOfWork.ReadData&lt;ExampleTable, ExampleTable&gt;(
        r =&gt; r.Get(t =&gt; t.Name == name));
    return JsonConvert.SerializeObject(readData);
}
</code></pre>

<p><code>UnitOfWork</code>不支持嵌套，需要多个仓储使用同一个数据库时请使用<code>RepositoryResolver</code><br/></p>
<pre><code class="csharp">UnitOfWork.Read(context =&gt; {
    var repository = RepositoryResolver.Resolve&lt;ExampleTable&gt;(context);
    var otherRepository = RepositoryResolver.Resolve&lt;OtherTable&gt;(context);
});
</code></pre>

<p>需要自定义仓储时，可以创建一个仓储类继承<code>GenericRepository</code>并注册到IoC容器，<br/>
解决仓储时会自动使用自定义的仓储。<br/></p>
<h3 id="_9"><h2>前台页模板</h2></h3>
<p>这个插件提供了以下的前台页模板，如有需要可以根据路径在其他插件中重载。</p>
<ul>
<li>common.base\footer.html (前台通用尾部)</li>
<li>common.base\header.html (前台通用头部)</li>
<li>common.base\index.html (首页)</li>
</ul>
<h3 id="_10"><h2>插件提供的标签和过滤器</h2></h3>
<p>这个插件提供了以下的标签<br/></p>
<ul>
<li>copyright_text<ul>
<li>显示版权信息文本</li>
<li>例: <code>{% copyright_text %}</code></li>
</ul>
</li>
<li>include_css_here<ul>
<li>在当前位置引用css文件</li>
<li>例: <code>{% include_css_here "/static/common.base.css/test.css" %}</code></li>
<li>例: <code>{% include_css_here variable %}</code></li>
</ul>
</li>
<li>include_css_later<ul>
<li>延迟引用css文件，需要配合"render_included_css"标签使用</li>
<li>这个标签会影响上下文内容，不应该在有缓存的模板模块中使用</li>
<li>例: <code>{% include_css_later "/static/common.base.css/test.css" %}</code></li>
<li>例: <code>{% include_css_later variable %}</code></li>
</ul>
</li>
<li>include_js_here<ul>
<li>在当前位置引用js文件</li>
<li>例: <code>{% include_js_here "/static/common.base.js/test.js" %}</code></li>
<li>例: <code>{% include_js_here variable %}</code></li>
</ul>
</li>
<li>include_js_later<ul>
<li>延迟引用javascript文件，需要配合"render_included_js"标签使用</li>
<li>这个标签会影响上下文内容，不应该在有缓存的模板模块中使用</li>
<li>例: <code>{% include_js_later "/static/common.base.js/test.js" %}</code></li>
<li>例: <code>{% include_js_later variable %}</code></li>
</ul>
</li>
<li>render_extra_metadata<ul>
<li>描画额外的meta标签</li>
<li>描画后会清空原有的内容，可以重复调用</li>
<li>例: <code>{% render_extra_metadata %}</code></li>
</ul>
</li>
<li>render_included_css<ul>
<li>描画延迟引用的css资源</li>
<li>描画后会清空原有的引用，可以重复调用</li>
<li>例: <code>{% render_included_css %}</code></li>
</ul>
</li>
<li>render_included_js<ul>
<li>描画延迟引用的javascript资源</li>
<li>描画后会清空原有的引用，可以重复调用</li>
<li>例: <code>{% render_included_js %}</code></li>
</ul>
</li>
<li>remder_meta_description<ul>
<li>描画页面描述</li>
<li>如果有指定关键词时使用指定的描述，否则使用网站设置中的描述</li>
<li>例: <code>{% remder_meta_description %}</code></li>
</ul>
</li>
<li>render_meta_keywords<ul>
<li>描画页面关键词</li>
<li>如果有指定关键词时使用指定的关键词，否则使用网站设置中的关键词</li>
<li>例: <code>{% render_meta_keywords %}</code></li>
</ul>
</li>
<li>render_title<ul>
<li>描画当前网站标题</li>
<li>例: <code>{% render_title %}</code></li>
</ul>
</li>
<li>url_pagination<ul>
<li>根据Url分页的控件，需要配合Model.Pagination使用</li>
<li>例: <code>{% url_pagination response.Pagination %}</code></li>
</ul>
</li>
<li>use_meta_description<ul>
<li>设置页面描述，需要配合"remder_meta_description"标签使用</li>
<li>例: <code>{% use_meta_description "description" %}</code></li>
<li>例: <code>{% use_meta_description variable %}</code></li>
</ul>
</li>
<li>use_meta_keywords<ul>
<li>设置页面关键词，需要配合"render_meta_keywords"标签使用</li>
<li>例: <code>{% use_meta_keywords "keywords" %}</code></li>
<li>例: <code>{% use_meta_keywords variable %}</code></li>
</ul>
</li>
<li>use_title<ul>
<li>设置网站标题，需要配合标签"render_title"使用</li>
<li>例: <code>{% use_title "Plain Text Title" %}</code></li>
<li>例: <code>{% use_title variable_title %}</code></li>
</ul>
</li>
<li>website_name<ul>
<li>显示当前网站名称</li>
<li>例: <code>{% website_name %}</code></li>
</ul>
</li>
</ul>
<p>这个插件提供了以下的过滤器<br/></p>
<ul>
<li>website_title<ul>
<li>网站标题</li>
<li>按WebsiteSettings.DocumentTitleFormat进行格式化</li>
<li>例: <code>{{ "Website Title" | website_title }}</code></li>
</ul>
</li>
<li>url<ul>
<li>全局过滤网址</li>
<li>请参考下面"全局过滤网址"的说明</li>
<li>例: <code>{{ "/example" | url }}</code></li>
</ul>
</li>
<li>url_get_param<ul>
<li>获取Url参数，传入的url是空值时使用当前请求的url</li>
<li>例: <code>{{ "" | url_get_param: "key" }}</code></li>
<li>例: <code>{{ test_url | url_get_param: variable }}</code></li>
</ul>
</li>
<li>url_set_param<ul>
<li>设置Url参数，传入的url是空值时使用当前请求的url</li>
<li>例: <code>{{ "" | url_set_param: "key", "value" | url }}</code></li>
<li>例: <code>{{ test_url | url_set_param: "key", variable | url }}</code></li>
</ul>
</li>
<li>url_remove_param<ul>
<li>删除Url参数，传入的url是空值时使用当前请求的url</li>
<li>例: <code>{{ "" | url_remove_param: "key" }}</code></li>
<li>例: <code>{{ test_url | url_remove_param: variable }}</code></li>
</ul>
</li>
<li>html_attributes<ul>
<li>描画Html标签</li>
<li>需要传入类型是<code>IDictionary&lt;string, string&gt;</code>的参数</li>
<li>例: <code>{{ attribtues | html_attributes }}</code></li>
</ul>
</li>
<li>json<ul>
<li>使用Json序列化对象</li>
<li>例: <code>{{ obj | json }}</code></li>
</ul>
</li>
</ul>
<h3 id="_11"><h2>静态文件处理器</h2></h3>
<p>这个插件提供了静态文件专用的路径<code>/static/文件路径</code>，查找规则如下<br/></p>
<ul>
<li>查找<code>App_Data\static\文件路径</code></li>
<li>按插件注册顺序反向查找<code>插件文件夹\static\文件路径</code></li>
</ul>
<p>例如注册了插件A和B时，查找<code>/static/a/homepage.js</code>顺序如下<br/></p>
<ul>
<li><code>App_Data\static\a\homepage.js</code></li>
<li><code>B\static\a\homepage.js</code></li>
<li><code>A\static\a\homepage.js</code></li>
</ul>
<h3 id="_12"><h2>语言时区处理器</h2></h3>
<p>这个插件可以自动设置当前请求的语言和时区。<br/>
默认语言和时区可以修改通用配置<code>LocaleSettings</code>。<br/></p>
<p>设置语言的顺序是<br/></p>
<ul>
<li>客户端传入的Cookies (LocaleUtils.LanguageKey: "ZKWeb.Language")</li>
<li>客户端浏览器语言，如果<code>LocaleSettings</code>设置允许检测浏览器语言</li>
<li><code>LocaleSettings</code>中的默认语言</li>
</ul>
<p>设置时区的顺序是<br/></p>
<ul>
<li>客户端传入的Cookies (LocaleUtils.TimeZoneKey: "ZKWeb.TimeZone")</li>
<li><code>LocaleSettings</code>中的默认时区</li>
</ul>
<h3 id="_13"><h2>特征类</h2></h3>
<p>特征类<code>Trait</code>用于在外部标记指定类型的某些特征，但不需要修改原有的类型。<br/>
这个插件提供了以下的特征类<br/></p>
<ul>
<li>EntityTrait (主键名称和类型)</li>
<li>RecyclableTrait (是否可回收)</li>
</ul>
<p>使用特征类的例子<br/></p>
<pre><code class="csharp">var entityTrait = EntityTrait.For&lt;TData&gt;();
var expression = ExpressionUtils.MakeMemberEqualiventExpression&lt;TData&gt;(entityTrait.PrimaryKey, id);
</code></pre>

<p>提供自定义特征类需要在插件初始化时注册到IoC容器<br/></p>
<pre><code class="csharp">Application.Ioc.RegisterInstance(
    new EntityTrait() { PrimaryKey = &quot;Id&quot;, PrimaryKeyType = typeof(Guid) },
    serviceKey: typeof(ExampleTableUseGuidPrimaryKey));
</code></pre>

<h3 id="_14"><h2>缓存的隔离策略</h2></h3>
<p>插件提供了以下的缓存策略:<br/>
关于缓存策略可以查看<a href="../../core/controller/">控制器和模板系统</a>。<br/></p>
<ul>
<li>Ident<br/>
  按当前登录用户隔离缓存</li>
</ul>
<h3 id="_15"><h2>全局过滤网址</h2></h3>
<p>为了支持伪静态等高级功能，这个插件提供了全局过滤网址的功能。<br/>
描画a标签的href等时应该添加<code>url</code>过滤器。<br/>
需要全局过滤网址时可以注册到<code>IUrlFilter</code>接口。<br/></p>
<pre><code class="html">&lt;a href=&quot;{{ &quot;/example/view?id=[0]&quot; | format: exampleId | url }}&quot;&gt;&lt;/a&gt;
</code></pre>
            

          </div> <!--/span-->
        </div> <!--/row-->
      </div> <!--/.fluid-container-->
    </div> <!--/.body content-->
    <div id="push"></div>
  </div> <!--/.wrapper -->

  <footer class="span12">
    <p>
		Copyright © 2016 303248153@github<br/>
		Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.
    </p>
  </footer>

  <!-- Le javascript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="../../js/jquery-1.8.1-min.js"></script>
  <script src="../../js/prettify-1.0.js"></script>
  <script src="../../js/bootstrap-2.1.1-min.js"></script>
  <script>var base_url = '../..';</script>
  <script src="../../mkdocs/js/require.js"></script>
  <script src="../../js/theme.js"></script>

  <script>
    var shiftWindow = function() {
      scrollBy(0, -50)
    };

    if (location.hash) shiftWindow();
    window.addEventListener("hashchange", shiftWindow);

    $('.dropdown-menu').on('click touchstart', function(event) {
      event.stopPropagation();
    });

    // Dynamically force sidenav/dropdown to no higher than browser window
    $('.side-nav, .dropdown-menu').css('max-height', window.innerHeight - 130);

    $(function() {
      $(window).resize(function() {
        $('.side-nav, .dropdown-menu').css('max-height', window.innerHeight - 130);
      });
    });
  </script>
</body>

</html>